<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Timezones Relative To CET Worktime</title>

  <link href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    body, html { height:100%; margin:0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    #map { position:fixed; inset:0; }
    .maplibregl-popup-content {
      padding: 12px 15px;
      font-size: 13px;
      line-height: 1.5;
      min-width: 200px;
    }
    .maplibregl-popup-content strong {
      font-size: 14px;
      color: #333;
      display: block;
      margin-bottom: 8px;
    }
    .info-line {
      margin: 4px 0;
      color: #555;
    }
    .info-label {
      font-weight: 600;
      color: #666;
    }
    
    /* Color scheme switcher */
    .scheme-switcher {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255, 255, 255, 0.95);
      padding: 12px 15px;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      z-index: 10;
      min-width: 200px;
    }
    .scheme-switcher h4 {
      margin: 0 0 8px 0;
      font-size: 13px;
      font-weight: 600;
      color: #333;
    }
    .scheme-switcher select {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
      background: white;
      cursor: pointer;
    }
    .scheme-switcher select:focus {
      outline: none;
      border-color: #3b82f6;
    }
    .scheme-description {
      font-size: 11px;
      color: #666;
      margin-top: 6px;
      line-height: 1.4;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  
  <!-- Color scheme switcher -->
  <div class="scheme-switcher">
    <h4>Color Scheme</h4>
    <select id="scheme-selector">
      <option value="high-contrast">High Contrast</option>
      <option value="gradient-cool">Cool Gradient (Original)</option>
      <option value="warm-cool">Warm/Cool</option>
      <option value="earth-tones">Earth Tones</option>
      <option value="rainbow">Rainbow</option>
      <option value="monochrome-blue">Monochrome Blue</option>
    </select>
    <div id="scheme-description" class="scheme-description"></div>
  </div>

  <script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/pmtiles@3.0.7/dist/pmtiles.js"></script>
  <script src="styles.js"></script>

  <script>
    // -------------- CONFIG --------------
    const PMTILES_URL = 'world_v3.pmtiles';
    const LAYER = 'countries';   // combined layer with both timezones and countries
    const TIMEZONE_OPACITY = 0.65;
    let currentScheme = 'high-contrast';  // Default color scheme
    // ------------------------------------

    // add pmtiles protocol handler to MapLibre
    const protocol = new pmtiles.Protocol();
    maplibregl.addProtocol('pmtiles', protocol.tile);

    // build map with PMTiles vector source
    const map = new maplibregl.Map({
      container: 'map',
      style: {
        version: 8,
        sources: {
          world: {
            type: 'vector',
            // pmtiles:// allows the pmtiles protocol handler to fetch
            url: 'pmtiles://' + PMTILES_URL,
            // Use tzid as the feature ID for feature-state
            promoteId: 'tzid'
          }
        },
        layers: [
          // Background (ocean/water color)
          {
            id: 'background',
            type: 'background',
            paint: {
              'background-color': '#c6e7ff'  // Light blue ocean color
            }
          },
          // timezone polygons (only features with tzid) - color based on work_hours_CET
          {
            id: 'timezones-fill',
            type: 'fill',
            source: 'world',
            'source-layer': LAYER,
            filter: ['has', 'tzid'],  // Only show features with timezone data
            paint: {
              'fill-color': getColorExpression(currentScheme),
              'fill-opacity': TIMEZONE_OPACITY
            }
          },
          // country borders (features without tzid)
          {
            id: 'countries-line',
            type: 'line',
            source: 'world',
            'source-layer': LAYER,
            filter: ['!', ['has', 'tzid']],  // Only show features without timezone data
            paint: {
              'line-color': 'rgba(100,100,100,0.3)',
              'line-width': 0.5
            }
          },
          // timezone borders
          {
            id: 'timezones-line',
            type: 'line',
            source: 'world',
            'source-layer': LAYER,
            filter: ['has', 'tzid'],
            paint: {
              'line-color': 'rgba(255,255,255,0.5)',
              'line-width': 0.8
            }
          },
          // highlight layer for hover using feature-state
          {
            id: 'timezones-highlight',
            type: 'line',
            source: 'world',
            'source-layer': LAYER,
            paint: {
              'line-color': '#000000',
              'line-width': [
                'case',
                ['boolean', ['feature-state', 'hover'], false],
                3,
                0
              ],
              'line-opacity': 0.9
            }
          }
        ]
      },
      center: [0, 20],
      zoom: 2
    });

    // Current popup reference
    let currentPopup = null;
    let hoveredFeatureId = null;

    map.on('load', () => {
      map.getCanvas().style.cursor = 'default';
    });

    // Hover effect - use feature-state for performance and show popup
    map.on('mousemove', 'timezones-fill', (e) => {
      if (e.features.length > 0) {
        const feature = e.features[0];
        const featureId = feature.id;
        
        // Skip features without valid IDs (countries without timezone data)
        if (!featureId) {
          if (hoveredFeatureId !== null) {
            map.setFeatureState(
              { source: 'world', sourceLayer: LAYER, id: hoveredFeatureId },
              { hover: false }
            );
            hoveredFeatureId = null;
          }
          if (currentPopup) {
            currentPopup.remove();
            currentPopup = null;
          }
          map.getCanvas().style.cursor = 'default';
          return;
        }
        
        map.getCanvas().style.cursor = 'pointer';
        
        // Only update if hovering a different feature
        if (featureId !== hoveredFeatureId) {
          // Remove hover state from previous feature
          if (hoveredFeatureId !== null) {
            map.setFeatureState(
              { source: 'world', sourceLayer: LAYER, id: hoveredFeatureId },
              { hover: false }
            );
          }
          
          // Set hover state on new feature
          hoveredFeatureId = featureId;
          map.setFeatureState(
            { source: 'world', sourceLayer: LAYER, id: featureId },
            { hover: true }
          );
          
          // Show popup for this feature
          const props = feature.properties || {};
          const tzid = props.tzid || 'Unknown';
          const work = props.work_hours_CET || 'N/A';
          const utc = props.UTC;
          const countryName = props.name || '';
          
          // Format UTC offset with sign
          const utcFormatted = (utc !== null && utc !== undefined)
            ? `UTC${parseInt(utc) >= 0 ? '+' : ''}${utc}` 
            : 'N/A';
          
          // Build popup HTML
          const html = `
            <strong>${tzid}</strong>
            ${countryName ? `<div style="font-size: 12px; color: #666; margin-top: 2px;">${countryName}</div>` : ''}
            <div class="info-line">
              <span class="info-label">UTC Offset:</span> ${utcFormatted}
            </div>
            <div class="info-line">
              <span class="info-label">CET Work Hours:</span> ${work}
            </div>
            <div style="margin-top: 8px; font-size: 11px; color: #888;">
              (When it's 09:00-17:00 in Central Europe)
            </div>
          `;
          
          // Close existing popup
          if (currentPopup) {
            currentPopup.remove();
          }
          
          // Create new popup
          currentPopup = new maplibregl.Popup({
            closeButton: false,
            closeOnClick: false,
            maxWidth: '300px'
          })
            .setLngLat(e.lngLat)
            .setHTML(html)
            .addTo(map);
        }
      }
    });

    // Remove highlight and popup when leaving
    map.on('mouseleave', 'timezones-fill', () => {
      map.getCanvas().style.cursor = 'default';
      
      if (hoveredFeatureId !== null) {
        map.setFeatureState(
          { source: 'world', sourceLayer: LAYER, id: hoveredFeatureId },
          { hover: false }
        );
        hoveredFeatureId = null;
      }
      
      if (currentPopup) {
        currentPopup.remove();
        currentPopup = null;
      }
    });
    
    // -------------- COLOR SCHEME SWITCHER --------------
    const schemeSelector = document.getElementById('scheme-selector');
    const schemeDescription = document.getElementById('scheme-description');
    
    // Initialize description
    const initialScheme = getSchemeInfo(currentScheme);
    schemeDescription.textContent = initialScheme.description;
    
    // Handle scheme changes
    schemeSelector.addEventListener('change', (e) => {
      const newScheme = e.target.value;
      currentScheme = newScheme;
      
      // Update map colors
      map.setPaintProperty('timezones-fill', 'fill-color', getColorExpression(newScheme));
      
      // Update description
      const schemeInfo = getSchemeInfo(newScheme);
      schemeDescription.textContent = schemeInfo.description;
    });
  </script>
</body>
</html>
